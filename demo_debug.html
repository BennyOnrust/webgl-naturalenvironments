<!DOCTYPE html>
<html lang="en">
	<head>
		<title>WebGL/three.js - 3D natural environments</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>
			body {
				color: #fff;
				font-family:Monospace;
				font-size:13px;
				text-align:center;

				background-color: #050505;
				margin: 0px;
				overflow: hidden;
			}

			#info {
				position: absolute;
				top: 0px; width: 100%;
				padding: 5px;
			}

			a {

				color: #0080ff;
			}

		</style>
	</head>
	<body>

		<div id="container"></div>
		<div id="info"> WebGL/three.js - 3D natural environments <br />(wasd+arrows: movement, p: toggle billboards, c: toggle plant models, b: toggle terrain, u: toggle LOD, k: toggle water, m: toggle shadows)</div>
		<script src="build/three_r69.js"></script>
                <script src="build/rStats.js"></script>
                <script src="build/rStats.extras.js"></script>
                
                <script src="ShaderLibrary.js"></script>
                <script src="Terrain.js"></script>
                <script src="DataManager.js"></script>
                <script src="Lights.js"></script>
                <script src="Skybox.js"></script>
                <script src="Dike.js"></script>
                <script src="Water.js"></script>
                <script src="PlantDistribution.js"></script>
		<script src="js/controls/FirstPersonControls.js"></script>
                <script src="js/controls/FlyControls.js"></script>
                <script src="js/controls/TrackballControls.js"></script>
                <script src="js/controls/OrbitControls.js"></script>
                <script src="js/loaders/OBJMTLLoader.js"></script>
                <script src="js/loaders/OBJLoader.js"></script>
                <script src="js/loaders/MTLLoader.js"></script>
                <script src="js/Mirror.js"></script>
		<script src="js/WaterShader_new.js"></script>
                <script src="js/shaders/FresnelShader_new.js"></script>
                <script src="js/loaders/TGALoader.js"></script>

                
                <script src="js/shaders/CopyShader.js"></script>
		<script src="js/shaders/BokehShader.js"></script>
                <script src="js/shaders/BlendShader.js"></script>
                <script src="js/shaders/SSAOShader.js"></script>
                <script src="js/shaders/FXAAShader.js"></script>
                <script src="js/shaders/ParallaxShader.js"></script>
                <script src="js/shaders/ColorCorrectionShader.js"></script>
                <script src="js/SkyShader.js"></script>

		<script src="js/postprocessing/EffectComposer.js"></script>
		<script src="js/postprocessing/RenderPass.js"></script>
                <script src="js/postprocessing/BloomPass.js"></script> 
		<script src="js/postprocessing/ShaderPass.js"></script>
		<script src="js/postprocessing/MaskPass.js"></script>
                <script src="js/postprocessing/DotScreenPass.js"></script> 
		<script src="js/postprocessing/BokehPass.js"></script>
                <script src="js/shaders/DotScreenShader.js"></script>
                <script src="js/shaders/BlendAdvancedShader.js"></script>

		<script src="js/Detector.js"></script>
		<script>

			if ( ! Detector.webgl ) {

				Detector.addGetWebGLMessage();
				document.getElementById( 'container' ).innerHTML = "";

			}
			var container, stats, sceneObject, sceneBillboard, renderStats;

			var camera, controls, renderer;
                        
                        var renderTargetObjects, renderTargetBillboards;

			var worldWidth, worldDepth;

			var clock = new THREE.Clock();
                        var pNumber = 0;
                                                
                        var billboards, objects, terrains, terrainObjects, plantModels;
                        var plantModelMaterials = [];

                        var scale = 2;
                        var images;
                        var frustum = new THREE.Frustum();
                        var billboardsVisible = true;
                        var objectsVisible = false;
                        var terrainsVisible = true;
                        var linesLODVisible = false;
                        var plantVisible = true;
                        var waterVisible = true;
                        var threshT = [];
                        var threshT2 = [];
                        var overlayStatus = false;
                        var overlayFactor = 0.0;
                        
                        var plantTypes = ["Elymus", "Spartina", "Atriplex", "Aster", "Limonium" ,"Artemisia", "Salicornia"];
                        var plantBillboardSizes = [1000,1000,430,600,270,550,250];
                        var nTextures = [3, 4, 1, 3, 3, 4, 1];
                        
                        var materialLines = new THREE.LineBasicMaterial({ color: "red" });
                        var offsetFrustum;
                        
                        var children = [];
                        var childrenNew = [];
                        var offsetTransition = 1.0;
                        
                        var levelsLOD = 6;
                        var levelLODselected = 0;
                        var offsetLOD = .5;
                        var locations;
                        var centerTerrains = [];
                        var terrainBoxes = [];
                        var transitionLength = 1.0;
                        
                        var postprocessing = {};
                        var BLENDING_MODE = true;
                        
                        var thresholdNear;
                        var thresholdFar;
                        var transitionZone = scale * 12.0;
                        var dike;
                        var speed = 0.5 * scale;
                        var lookat = false;
                        
                        var fps = 10;
                        var now;
                        var then = Date.now();
                        var interval = 1000/fps;
                        var delta;
                        
                        var distT, bboxT, dist, frustT, distT2, objectRange, billboardRange;
                        var objectBox = new THREE.Box2();
                        var billboardBox = new THREE.Box2();
                        var camPos = new THREE.Vector2(0.0,0.0);
                        var maxDist;
                        var maxDistBillboard;
                        var transitionZoneBillboards = 35 * scale;
                        var offsetLODTerrain = 0.3;
                        var worldCoordinates;
                        
                        var quality = 0.0;
                        var qualityMultiplier;
                        var thresholdBillboard;
                        var billboardSizeMultiplier;
                        var heightScale;
                        var plantModelSizes;
                        var offsetDist;
                        var resolution;
                        if (quality === 0){ // HIGH Quality
                            resolution = 1.0;
                            qualityMultiplier = 1.0;
                            billboardSizeMultiplier = 6;
                            thresholdBillboard = 250 * scale;
                            heightScale = 4;
                            offsetDist = .3;
                            plantModelSizes = [0.3*scale*qualityMultiplier,0.3*scale*qualityMultiplier,
                                0.2*scale*qualityMultiplier,0.23*scale*qualityMultiplier,0.15*scale*qualityMultiplier,
                                0.3*scale*qualityMultiplier,0.3*scale*qualityMultiplier];
                        }
                        else if(quality === 1){ //MEDIUM Quality
                            resolution = 1.5;
                            qualityMultiplier = 1.7;
                            billboardSizeMultiplier = 6 * qualityMultiplier;
                            thresholdBillboard = 125 * scale;
                            heightScale = 4;
                            offsetDist = .6;
                            plantModelSizes = [0.3*scale*qualityMultiplier,0.3*scale*qualityMultiplier,
                                0.2*scale*qualityMultiplier,0.23*scale*qualityMultiplier,0.15*scale*qualityMultiplier,
                                0.3*scale*qualityMultiplier,0.3*scale*qualityMultiplier];
                        }
                        else if(quality === 2){ // LOW Quality
                            resolution = 2.0;
                            qualityMultiplier = 2.0;
                            billboardSizeMultiplier = 6 * qualityMultiplier;
                            thresholdBillboard = 100 * scale;
                            heightScale = 4 * qualityMultiplier;
                            offsetDist = .9;
                            plantModelSizes = [0.3*scale*qualityMultiplier,0.3*scale*qualityMultiplier,
                                0.2*scale*qualityMultiplier,0.23*scale*qualityMultiplier,0.15*scale*qualityMultiplier,
                                0.3*scale*qualityMultiplier,0.3*scale*qualityMultiplier];
                        }
                        
                        heightImageLink1 = "images/heightMap_Paulinapolder.png";
                        heightImageLink2 = "images/heightMap_Paulinapolder_v2.png";

                        mudImageLink = 'images/mudTilingColor.png';
                        grassImageLink = 'images/grassTilingColor.png';

                        mudNormalLink = 'images/mudNormals.png'
                        skyBoxImagePath = 'images/skybox/';

                        if(quality === 0.0){
                            locationsTextLink = "data/locations.txt";
                        }
                        else if(quality === 1.0){
                            locationsTextLink = "data/locations_08.txt";
                        }
                        else if(quality === 2.0){
                            locationsTextLink = "data/locations_16.txt";
                        }

                        modelElymusObjLink = 'Models/Elymus.obj';
                        modelElymusMtlLink = 'Models/Elymus.mtl';
                        modelSpartinaObjLink = 'Models/Spartina.obj';
                        modelSpartinaMtlLink = 'Models/Spartina.mtl';
                        modelAtriplexObjLink = 'Models/Atriplex.obj';
                        modelAtriplexMtlLink = 'Models/Atriplex.mtl';
                        modelAsterObjLink = 'Models/Aster.obj';
                        modelAsterMtlLink = 'Models/Aster.mtl';
                        modelLimoniumObjLink = 'Models/Limonium.obj';
                        modelLimoniumMtlLink = 'Models/Limonium.mtl';
                        modelArtemisiaObjLink = 'Models/Artemisia.obj';
                        modelArtemisiaMtlLink = 'Models/Artemisia.mtl';
                        modelSalicorniaObjLink = 'Models/Salicornia.obj';
                        modelSalicorniaMtlLink = 'Models/Salicornia.mtl';

                        texturesElymusLink = 'Models/Textures/ElymusMap.png';
                        texturesSpartinaLink = 'Models/Textures/SpartinaMap.png';
                        texturesAtriplexLink = 'Models/Textures/AtriplexMap.png';
                        texturesAsterLink = 'Models/Textures/AsterMap.png';
                        texturesArtemisiaLink = 'Models/Textures/ArtemisiaMap.png';
                        texturesLimoniumLink = 'Models/Textures/LimoniumMap.png';
                        texturesSalicorniaLink = 'Models/Textures/SalicorniaMap.png';

                        billboardsLink = "Billboards/cubeTextureAtlas.png";
                        billboardTextureMapLink = "Billboards/Billboards_Mipmap_1024.tga";
                        billboardTextureMapLink = "Billboards/Billboards_Mipmap_2048.tga";
                        billboardTextureMapLink = "Billboards/Billboards_Mipmap_4096.tga";
                        billboardTextureMapLink = "Billboards/Billboards_Mipmap_4096_Repetition.tga";
                        farawayTextureMapLink = "Billboards/Billboards_Mipmap_1024_background.tga";
                        dikeModelObjLink = "Models/dijk.obj";
                        dikeModelTextureLink = "Models/Textures/dykeTilingColor.png";
                        waveNormalLink = "images/waternormals.jpg";
                        
                        var terrain;
                                                
                        preloadimages([heightImageLink1,heightImageLink2]).done(function(loadedImages){
                            images = loadedImages;
                            preLoadPlantModel([modelElymusObjLink,modelElymusMtlLink, modelSpartinaObjLink,modelSpartinaMtlLink, modelAtriplexObjLink,modelAtriplexMtlLink, modelAsterObjLink,modelAsterMtlLink, modelLimoniumObjLink,modelLimoniumMtlLink, modelArtemisiaObjLink,modelArtemisiaMtlLink, modelSalicorniaObjLink,modelSalicorniaMtlLink]).done(function(loadedModels){
                                plantModels = loadedModels;
                                preLoadLocations(locationsTextLink).done(function(loadedLocations){
                                    locations = loadedLocations;
                                    preLoadDike(dikeModelObjLink).done(function(loadedDike){
                                        dike = loadedDike;
                                        init();
                                        animate();
                                    });
                                });
                            });
                        });

			function init() {
				container = document.getElementById( 'container' );
                                
                                camera = new THREE.PerspectiveCamera( 30, window.innerWidth / window.innerHeight, .06 * scale, scale * 680 );
                                camera.position.y = scale*(heightScale+2);
                                camera.position.x = -105 * scale;
                                camera.position.z = -125 * scale;
                                camera.rotation.x += 0;
                                camera.rotation.y += 180;
                                camera.rotation.z += 0;
                                
                                controls = new THREE.FlyControls( camera );

				controls.movementSpeed = speed;
				controls.domElement = container;
				controls.rollSpeed = (Math.PI / 240) * (1 / scale);
				controls.autoForward = false;
				controls.dragToLook = true;
				sceneObject = new THREE.Scene();
                                sceneBillboard = new THREE.Scene();
                                
                                renderer = new THREE.WebGLRenderer({ antialias: true,logarithmicDepthBuffer: false });
                                var windowWidth = window.innerWidth / resolution;
                                var windowHeight = window.innerHeight / resolution;
                                var pixelRatio = window.devicePixelRatio;
                                renderer.setSize( windowWidth, windowHeight );        
                                //renderer.setViewport( 0, 0, windowWidth*pixelRatio, windowHeight*pixelRatio );
				container.appendChild( renderer.domElement );
                                renderer.gammaInput = true;
				renderer.gammaOutput = true;
                                renderer.autoClear = false;
                                renderer.shadowMapEnabled = true;
				renderer.shadowMapType = THREE.PCFSoftShadowMap;

                                var pixelWidth = Math.floor( windowWidth  / pixelRatio );
                                var pixelHeight = Math.floor( windowHeight  / pixelRatio );
                                var parameters = { minFilter: THREE.LinearFilter, magFilter: THREE.LinearFilter, format: THREE.RGBAFormat, stencilBuffer: false };

                                renderTargetObjects = new THREE.WebGLRenderTarget( pixelWidth, pixelHeight, parameters );
                                renderTargetBillboards = new THREE.WebGLRenderTarget( pixelWidth, pixelHeight, parameters );
                                renderTargetBlend = new THREE.WebGLRenderTarget( pixelWidth, pixelHeight, { minFilter: THREE.LinearFilter, magFilter: THREE.LinearFilter, format: THREE.RGBFormat, stencilBuffer: false } );
                                
                                var dataManager = new DataManager();
                                
                                var depthMaterial = new THREE.ShaderMaterial(ShaderLibrary['depthRGBA_instancing']);
                                depthMaterial._shadowPass = true;
                                
                                THREE.ImageUtils.crossOrigin = '';
                                var mudTexture = THREE.ImageUtils.loadTexture(mudImageLink);
                                mudTexture.wrapT = THREE.RepeatWrapping;
                                mudTexture.wrapS = THREE.RepeatWrapping;
                                mudTexture.repeat.set(1.0*scale,1.0*scale);
                                var grassTexture = THREE.ImageUtils.loadTexture(grassImageLink);
                                grassTexture.wrapT = THREE.RepeatWrapping;
                                grassTexture.wrapS = THREE.RepeatWrapping;
                                grassTexture.repeat.set(1*scale,1*scale);
                                
                                var dikeTexture = THREE.ImageUtils.loadTexture(dikeModelTextureLink);
                                dikeTexture.wrapT = THREE.RepeatWrapping;
                                dikeTexture.wrapS = THREE.RepeatWrapping;
                                dikeTexture.repeat.set(1,1);
                                
                                var waveNormal = THREE.ImageUtils.loadTexture(waveNormalLink);
                                waveNormal.wrapT = THREE.RepeatWrapping;
                                waveNormal.wrapS = THREE.RepeatWrapping;
                                waveNormal.repeat.set(1,1);
                                
                                var mudNormal = THREE.ImageUtils.loadTexture(mudNormalLink); 
                                mudNormal.wrapT = THREE.RepeatWrapping;
                                mudNormal.wrapS = THREE.RepeatWrapping;
                                mudNormal.repeat.set(1,1);
                                
                                var tgaloader = new THREE.TGALoader();
                                billboardTextureMap =  tgaloader.load( billboardTextureMapLink );
                                farawayTextureMap = tgaloader.load(farawayTextureMapLink);
                                
                                var path = skyBoxImagePath;
				var format = '.jpg';
				var urls = [
						path + 'px' + format, path + 'nx' + format,
						path + 'py' + format, path + 'ny' + format,
						path + 'pz' + format, path + 'nz' + format
					];
                                
                                var skyboxTexture = THREE.ImageUtils.loadTextureCube( urls );
				skyboxTexture.format = THREE.RGBFormat;
                                skyboxTexture.mapping = THREE.CubeReflectionMapping;
                                
                                // LIGHTS
                                lightsObject = new Lights(scale, camera.fov, "object");
                                lightsBillboard = new Lights(scale, camera.fov, "billboard");
                                sceneObject.add(lightsObject);
                                sceneBillboard.add(lightsBillboard);
                                
                                // DIKE
                                var dikeMesh = new Dike(scale, heightScale, dike, dikeTexture);
                                sceneBillboard.add(dikeMesh);                              
                                
                                // SKYBOX                                
                                var skybox = new Skybox(scale, skyboxTexture);
                                sceneBillboard.add(skybox);
                                
                                // WORLD INFORMATION
                                var image = images[0];
                                worldWidth = image.width;
                                worldDepth = image.height; 
                                
                                var data = getHeight(image);
                                var data2 = getHeight(images[1]);
                                
                                // Water
                                waterObject = new Water(scale, worldWidth, worldDepth, heightScale, 0.2, lightsObject.hemiLight.position, waveNormal, skyboxTexture, "object");
                                waterBillboard = new Water(scale, worldWidth, worldDepth, heightScale, 0.2, lightsObject.hemiLight.position, waveNormal, skyboxTexture, "billboard");
                                sceneObject.add(waterObject);
                                sceneBillboard.add(waterBillboard);                               
                                
                                // TERRAIN
                                terrain = new Terrain(scale, worldWidth, worldDepth, heightScale, data, data2);
                                
                                customMaterialPhong = new THREE.ShaderMaterial( ShaderLibrary['terrainPhongNear']  );
                                customMaterialLambert = new THREE.ShaderMaterial( ShaderLibrary['terrainPhongFar']  );
                                
                                var maxHeight = terrain.maxHeight;
                                var terrainmesh = new THREE.Mesh(terrain.terrainGeometry, customMaterialPhong);
                                terrainmesh.visible = false;
                                
                                // Calculate positions
                                plantDistribution = new PlantDistribution(scale, worldWidth, worldDepth, plantTypes, levelsLOD, locations, terrain, plantModelSizes, plantBillboardSizes, billboardSizeMultiplier, offsetDist);
                                
                                terrains = [];
                                linesLOD = [];
                                terrainToObjectIDs = [];
                                for (var l = 0; l < levelsLOD; l++){
                                    terrains[l] = [];
                                    linesLOD[l] = [];
                                    centerTerrains[l] = [];
                                    terrainToObjectIDs[l] = [];
                                    terrainBoxes[l] = [];
                                    
                                    var nParents, parent, nTerrainBlocksWidth, nTerrainBlocksDepth, nWidth, nDepth; 
                                    if(l === 0){
                                        nParents = 1;
                                        nTerrainBlocksWidth = 1;
                                        nTerrainBlocksDepth = 1;
                                        parent = terrainmesh;
                                    }
                                    else{
                                        nParents = terrains[l-1].length;
                                        nTerrainBlocksWidth = 2;
                                        nTerrainBlocksDepth = 2;
                                    }
                                    nWidth = Math.pow(2,l);
                                    nDepth = Math.pow(2,l);
                                    var tileSizeX = worldWidth / nWidth;
                                    var tileSizeY = worldDepth / nDepth;
                                    var tid = 0;
                                    
                                    threshT[l] = Math.sqrt(tileSizeX*tileSizeX + tileSizeY*tileSizeY) * scale;
                                    threshT2[l] = threshT[l] * 2.0;
                                    for(var q = 0; q < nParents; q++) {
                                        if(l !== 0){
                                            parent = terrains[l-1][q];
                                        }
                                        var width, depth;
                                        var parentWidth = Math.ceil(parent.geometry.boundingBox.size().x / scale);
                                        var parentDepth = Math.ceil(parent.geometry.boundingBox.size().z / scale); 

                                        var totWidth = 0;
                                        var totDepth = 0;

                                        var offsetWidth = 0;
                                        var offsetDepth = 0;
                                        var tBlockWidth = (parentWidth-1) / nTerrainBlocksWidth;
                                        var tBlockDepth = (parentDepth-1) / nTerrainBlocksDepth;
                                        var terrainBlockWidth = Math.floor(tBlockWidth);
                                        var terrainBlockDepth = Math.floor(tBlockDepth);
                                        var remainderWidth = (terrainBlockWidth - tBlockWidth) * nTerrainBlocksWidth;
                                        var remainderDepth = (terrainBlockDepth - tBlockDepth) * nTerrainBlocksDepth;

                                        var thresholdWidth, thresholdDepth;
                                        if(remainderWidth > 0){
                                            thresholdWidth = nTerrainBlocksWidth - remainderWidth;
                                        }
                                        else{
                                            thresholdWidth = nTerrainBlocksWidth - (-1 * remainderWidth);
                                            offsetWidth = 2;
                                        }
                                        thresholdWidth = Math.round(thresholdWidth);

                                        if(remainderDepth > 0){
                                            thresholdDepth = nTerrainBlocksDepth - remainderDepth;
                                        }
                                        else{
                                            thresholdDepth = nTerrainBlocksDepth - (-1 * remainderDepth);
                                            offsetDepth = 2;
                                        }
                                        thresholdDepth = Math.round(thresholdDepth);

                                        for(var i = 0; i < nTerrainBlocksDepth; i++){
                                            totWidth = 0;
                                            for(var j = 0; j < nTerrainBlocksWidth; j++){
                                                if (i >= thresholdDepth){
                                                    depth = terrainBlockDepth + offsetDepth;
                                                }
                                                else{
                                                    depth = terrainBlockDepth+1;
                                                }
                                                if(j >= thresholdWidth){
                                                    width = terrainBlockWidth + offsetWidth;
                                                }
                                                else{
                                                    width = terrainBlockWidth+1;
                                                }
                                                
                                                terrains[l][tid] = generateTerrainQuad(width,depth,totWidth,totDepth,parent, customMaterialLambert);
                                                sceneBillboard.add( terrains[l][tid] );

                                                linesLOD[l][tid] = drawLines(terrains[l][tid]);
                                                sceneBillboard.add( linesLOD[l][tid] );
                                                
                                                centerTerrains[l][tid] = new THREE.Vector3();
                                                
                                                var terrainSize = terrains[l][tid].geometry.boundingBox.size();
                                                var terrainMinimum = terrains[l][tid].geometry.boundingBox.min;
                                                centerTerrains[l][tid].x = terrainMinimum.x + (terrainSize.x / 2);
                                                centerTerrains[l][tid].z = terrainMinimum.z + (terrainSize.z / 2);
                                                terrainBoxes[l][tid] = new THREE.Box2();
                                                terrainBoxes[l][tid].setFromCenterAndSize(new THREE.Vector2(centerTerrains[l][tid].x,centerTerrains[l][tid].z), new THREE.Vector2(terrainSize.x,terrainSize.z));

                                                var tMinScaledX = terrainMinimum.x / scale;
                                                var tMinScaledZ = terrainMinimum.z / scale;
                                                tMinScaledX += worldWidth/2;
                                                tMinScaledZ += worldDepth/2;
                                                
                                                var nxn = tMinScaledX / tileSizeX;
                                                var nyn = tMinScaledZ / tileSizeY;
                                                var nx = Math.round(nxn);
                                                var ny = Math.round(nyn);
                                                
                                                terrainToObjectIDs[l][tid] = nx + ny * nWidth;

                                                totWidth += (width-1);

                                                tid++; 
                                            }
                                            totDepth += (depth-1);
                                        }
                                    }
                                }
                                thresholdNear = threshT[levelsLOD-1];
                                
                                customMaterialPhong.uniforms.grassTexture.value = grassTexture;
                                customMaterialPhong.uniforms.mudTexture.value = mudTexture;
                                customMaterialPhong.uniforms.heightScale.value = maxHeight;
                                customMaterialPhong.uniforms.threshNear.value = thresholdNear * offsetLOD;
                                customMaterialPhong.uniforms.threshFar.value = thresholdNear * offsetLOD + transitionZone;
                                customMaterialPhong.uniforms.normalMap.value = mudNormal;
                                customMaterialPhong.uniforms.normalScale.value = new THREE.Vector2(1.1,1.1);
                                customMaterialPhong.uniforms.environmentCube.value = skyboxTexture;
                                                                
                                customMaterialLambert.uniforms.grassTexture.value = grassTexture;
                                customMaterialLambert.uniforms.mudTexture.value = mudTexture;
                                customMaterialLambert.uniforms.heightScale.value = maxHeight;
                                customMaterialLambert.uniforms.threshNear.value = thresholdNear * offsetLOD;
                                customMaterialLambert.uniforms.threshFar.value = thresholdNear * offsetLOD + transitionZone;
                                customMaterialLambert.uniforms.threshLODNear.value = thresholdBillboard - transitionZoneBillboards * offsetLODTerrain;
                                customMaterialLambert.uniforms.threshLODFar.value = thresholdBillboard + transitionZoneBillboards * offsetLODTerrain;
                                customMaterialLambert.uniforms.farawayTexture.value = farawayTextureMap;
                                customMaterialLambert.uniforms.normalMap.value = mudNormal;
                                customMaterialLambert.uniforms.normalScale.value = new THREE.Vector2(1.1,1.1);
                                customMaterialLambert.uniforms.environmentCube.value = skyboxTexture;
                                customMaterialLambert.uniforms.overlayFactor.value = overlayFactor;
                                
                                waterObject.waterMesh.material.uniforms.threshNear.value = thresholdNear * offsetLOD;
                                waterObject.waterMesh.material.uniforms.threshFar.value = thresholdNear * offsetLOD + transitionZone;
                                
                                waterBillboard.waterMesh.material.uniforms.threshNear.value = thresholdNear * offsetLOD;
                                waterBillboard.waterMesh.material.uniforms.threshFar.value = thresholdNear * offsetLOD + transitionZone;
                                
                                var offsetX = terrains[levelsLOD-1][0].geometry.boundingBox.size().x;
                                var offsetZ = terrains[levelsLOD-1][0].geometry.boundingBox.size().z;
                                
                                offsetFrustum =  -1 * (offsetX + offsetZ);
                                
                                terrainObjects = [];
                                for(var i = 0; i < terrains[levelsLOD-1].length; i++){
                                    terrainObjects[i] = new THREE.Mesh(terrains[levelsLOD-1][i].geometry,customMaterialPhong);
                                    terrainObjects[i].frustumCulled = false;
                                    terrainObjects[i].autoupdate = false;
                                    terrainObjects[i].visible = false;
                                    terrainObjects[i].updateMatrix();
                                    terrainObjects[i].castShadow = false;
                                    terrainObjects[i].receiveShadow = true;
                                    sceneObject.add(terrainObjects[i]);
                                }
                                
                                console.log("merging");
                                var objectPositionMerged = [];
                                var objectColorsMerged = [];
                                var objectScaleMerged = [];
                                var objectRotationMerged = [];
                                var objectPlantTypeMerged = [];
                                var billboardPositionsMerged = [];
                                var billboardSizesMerged = [];
                                var objectColorRandomMerged = [];
                                var billboardTextureNumberMerged = [];
                                objectPositionMerged[levelsLOD-1] = plantDistribution.objectPositions; 
                                objectColorsMerged[levelsLOD-1] = plantDistribution.objectColors;
                                objectScaleMerged[levelsLOD-1] = plantDistribution.objectScales;
                                objectRotationMerged[levelsLOD-1] = plantDistribution.objectRotations;
                                objectPlantTypeMerged[levelsLOD-1] = plantDistribution.objectPlantType;
                                billboardPositionsMerged[levelsLOD-1] = plantDistribution.billboardPositions;
                                billboardSizesMerged[levelsLOD-1] = plantDistribution.billboardSizes;
                                objectColorRandomMerged[levelsLOD-1] = plantDistribution.objectColorRandom;
                                billboardTextureNumberMerged[levelsLOD-1] = plantDistribution.billboardTextureNumber;
                                
                                for(var i = levelsLOD-1; i > 0; i--){
                                    objectPositionMerged[i-1] = [];
                                    objectColorsMerged[i-1] = [];
                                    objectScaleMerged[i-1] = [];
                                    objectRotationMerged[i-1] = [];
                                    objectPlantTypeMerged[i-1] = [];
                                    billboardPositionsMerged[i-1] = [];
                                    billboardSizesMerged[i-1] = [];
                                    objectColorRandomMerged[i-1] = [];
                                    billboardTextureNumberMerged[i-1] = [];
                                    var nWidth = Math.pow(2,(i));
                                    var nDepth = Math.pow(2,(i));
                                    var index = 0;
                                    var length0,length1,length2,length3;
                                    for(var ny = 0; ny < nDepth; ny+=2){
                                        for(var nx = 0; nx < nWidth; nx+=2){
                                            length0 = objectPositionMerged[i][nx + ny * nWidth].length;
                                            length1 = objectPositionMerged[i][(nx + 1) + ny * nWidth].length;
                                            length2 = objectPositionMerged[i][nx + (ny + 1) * nWidth].length;
                                            length3 = objectPositionMerged[i][(nx + 1) + (ny + 1) * nWidth].length;
                                            
                                            objectPositionMerged[i-1][index] = new Float32Array(length0 + length1 + length2 + length3);
                                            objectPositionMerged[i-1][index].set(objectPositionMerged[i][nx + ny * nWidth],0); 
                                            objectPositionMerged[i-1][index].set(objectPositionMerged[i][(nx + 1) + ny * nWidth],length0); 
                                            objectPositionMerged[i-1][index].set(objectPositionMerged[i][nx + (ny + 1) * nWidth],length0 + length1);
                                            objectPositionMerged[i-1][index].set(objectPositionMerged[i][(nx + 1) + (ny + 1) * nWidth],length0 + length1 + length2);

                                            objectColorsMerged[i-1][index] = new Float32Array(length0 + length1 + length2 + length3);
                                            objectColorsMerged[i-1][index].set(objectColorsMerged[i][nx + ny * nWidth],0);
                                            objectColorsMerged[i-1][index].set(objectColorsMerged[i][(nx + 1) + ny * nWidth],length0);
                                            objectColorsMerged[i-1][index].set(objectColorsMerged[i][nx + (ny+1) * nWidth],length0 + length1);
                                            objectColorsMerged[i-1][index].set(objectColorsMerged[i][(nx + 1) + (ny + 1) * nWidth],length0 + length1 + length2);
                                            
                                            objectScaleMerged[i-1][index] = new Float32Array(length0 + length1 + length2 + length3);
                                            objectScaleMerged[i-1][index].set(objectScaleMerged[i][nx + ny * nWidth],0);
                                            objectScaleMerged[i-1][index].set(objectScaleMerged[i][(nx + 1) + ny * nWidth],length0);
                                            objectScaleMerged[i-1][index].set(objectScaleMerged[i][nx + (ny+1) * nWidth],length0 + length1);
                                            objectScaleMerged[i-1][index].set(objectScaleMerged[i][(nx + 1) + (ny + 1) * nWidth],length0 + length1 + length2);
                                            
                                            objectRotationMerged[i-1][index] = new Float32Array(length0 + length1 + length2 + length3);
                                            objectRotationMerged[i-1][index].set(objectRotationMerged[i][nx + ny * nWidth],0);
                                            objectRotationMerged[i-1][index].set(objectRotationMerged[i][(nx + 1) + ny * nWidth],length0);
                                            objectRotationMerged[i-1][index].set(objectRotationMerged[i][nx + (ny+1) * nWidth],length0 + length1);
                                            objectRotationMerged[i-1][index].set(objectRotationMerged[i][(nx + 1) + (ny + 1) * nWidth],length0 + length1 + length2);
                                            
                                            objectPlantTypeMerged[i-1][index] = new Float32Array((length0 + length1 + length2 + length3)/3);
                                            objectPlantTypeMerged[i-1][index].set(objectPlantTypeMerged[i][nx + ny * nWidth],0);
                                            objectPlantTypeMerged[i-1][index].set(objectPlantTypeMerged[i][(nx + 1) + ny * nWidth],length0/3);
                                            objectPlantTypeMerged[i-1][index].set(objectPlantTypeMerged[i][nx + (ny+1) * nWidth],(length0 + length1)/3);
                                            objectPlantTypeMerged[i-1][index].set(objectPlantTypeMerged[i][(nx + 1) + (ny + 1) * nWidth],(length0 + length1 + length2)/3);
                                            
                                            billboardPositionsMerged[i-1][index] = new Float32Array((length0 + length1 + length2 + length3));
                                            billboardPositionsMerged[i-1][index].set(billboardPositionsMerged[i][nx + ny * nWidth],0);
                                            billboardPositionsMerged[i-1][index].set(billboardPositionsMerged[i][(nx + 1) + ny * nWidth],length0);
                                            billboardPositionsMerged[i-1][index].set(billboardPositionsMerged[i][nx + (ny+1) * nWidth],(length0 + length1));
                                            billboardPositionsMerged[i-1][index].set(billboardPositionsMerged[i][(nx + 1) + (ny + 1) * nWidth],(length0 + length1 + length2));
                                            
                                            billboardSizesMerged[i-1][index] = new Float32Array((length0 + length1 + length2 + length3)/3);
                                            billboardSizesMerged[i-1][index].set(billboardSizesMerged[i][nx + ny * nWidth],0);
                                            billboardSizesMerged[i-1][index].set(billboardSizesMerged[i][(nx + 1) + ny * nWidth],length0/3);
                                            billboardSizesMerged[i-1][index].set(billboardSizesMerged[i][nx + (ny+1) * nWidth],(length0 + length1)/3);
                                            billboardSizesMerged[i-1][index].set(billboardSizesMerged[i][(nx + 1) + (ny + 1) * nWidth],(length0 + length1 + length2)/3);
                                            
                                            objectColorRandomMerged[i-1][index] = new Float32Array(length0 + length1 + length2 + length3);
                                            objectColorRandomMerged[i-1][index].set(objectColorRandomMerged[i][nx + ny * nWidth],0);
                                            objectColorRandomMerged[i-1][index].set(objectColorRandomMerged[i][(nx + 1) + ny * nWidth],length0);
                                            objectColorRandomMerged[i-1][index].set(objectColorRandomMerged[i][nx + (ny+1) * nWidth],length0 + length1);
                                            objectColorRandomMerged[i-1][index].set(objectColorRandomMerged[i][(nx + 1) + (ny + 1) * nWidth],length0 + length1 + length2);
                                            
                                            billboardTextureNumberMerged[i-1][index] = new Float32Array((length0 + length1 + length2 + length3)/3);
                                            billboardTextureNumberMerged[i-1][index].set(billboardTextureNumberMerged[i][nx + ny * nWidth],0);
                                            billboardTextureNumberMerged[i-1][index].set(billboardTextureNumberMerged[i][(nx + 1) + ny * nWidth],length0/3);
                                            billboardTextureNumberMerged[i-1][index].set(billboardTextureNumberMerged[i][nx + (ny+1) * nWidth],(length0 + length1)/3);
                                            billboardTextureNumberMerged[i-1][index].set(billboardTextureNumberMerged[i][(nx + 1) + (ny + 1) * nWidth],(length0 + length1 + length2)/3);
                                            index++;
                                        }
                                    }
                                }
                                
                                
                                var plantPositions = [];
                                var plantRotations = [];
                                var plantScales = [];
                                var plantColors = [];
                                for(var i = 0; i < plantTypes.length; i++){
                                    plantPositions[i] = [];
                                    plantRotations[i] = [];
                                    plantScales[i] = [];
                                    plantColors[i] = [];
                                }
                                
                                var pt;
                                for (var i = 0; i < plantDistribution.totalBlocks; i++){
                                    
                                    for(var t = 0; t < plantTypes.length; t++){
                                        plantPositions[t][i] = [];
                                        plantRotations[t][i] = [];
                                        plantScales[t][i] = [];
                                        plantColors[t][i] = [];
                                    }
                                    
                                    for (var j = 0; j < plantDistribution.objectPlantType[i].length; j++){
                                        pt = plantDistribution.objectPlantType[i][j];
                                        for(var t = 0; t < plantTypes.length; t++){
                                            if(t === pt){
                                                plantPositions[t][i].push(plantDistribution.objectPositions[i][j*3 + 0]);
                                                plantPositions[t][i].push(plantDistribution.objectPositions[i][j*3 + 1]);
                                                plantPositions[t][i].push(plantDistribution.objectPositions[i][j*3 + 2]);
                                                plantRotations[t][i].push(plantDistribution.objectRotations[i][j*3 + 0]);
                                                plantRotations[t][i].push(plantDistribution.objectRotations[i][j*3 + 1]);
                                                plantRotations[t][i].push(plantDistribution.objectRotations[i][j*3 + 2]);
                                                plantScales[t][i].push(plantDistribution.objectScales[i][j*3 + 0]);
                                                plantScales[t][i].push(plantDistribution.objectScales[i][j*3 + 1]);
                                                plantScales[t][i].push(plantDistribution.objectScales[i][j*3 + 2]);
                                                plantColors[t][i].push(plantDistribution.objectColorRandom[i][j*3 + 0]);
                                                plantColors[t][i].push(plantDistribution.objectColorRandom[i][j*3 + 1]);
                                                plantColors[t][i].push(plantDistribution.objectColorRandom[i][j*3 + 2]);
                                                break;
                                            }
                                        }
                                    }
                                }
                                
                                var plantInstancePositions = [];
                                var plantInstanceRotations = [];
                                var plantInstanceScales = [];
                                var plantInstanceColors = [];
                                
                                for(var t = 0; t < plantTypes.length; t++){
                                    plantInstancePositions[t] = [];
                                    plantInstanceRotations[t] = [];
                                    plantInstanceScales[t] = [];
                                    plantInstanceColors[t] = []
                                    for(var i = 0; i < plantDistribution.totalBlocks; i++){
                                        plantInstancePositions[t][i] = new Float32Array(plantPositions[t][i]);
                                        plantInstanceRotations[t][i] = new Float32Array(plantRotations[t][i]);
                                        plantInstanceScales[t][i] = new Float32Array(plantScales[t][i]);
                                        plantInstanceColors[t][i] = new Float32Array(plantColors[t][i]);
                                    }
                                }
                                
                                console.log("done merging");

                                console.log("Billboard creation");
                                
                                customMaterialBillboards = new THREE.ShaderMaterial(ShaderLibrary['billboard']);
                                billboardTextures = THREE.ImageUtils.loadTexture( billboardsLink );
                                
                                plantModelMaterials[0] = THREE.ImageUtils.loadTexture( texturesElymusLink );
                                plantModelMaterials[1] = THREE.ImageUtils.loadTexture( texturesSpartinaLink );
                                plantModelMaterials[2] = THREE.ImageUtils.loadTexture( texturesAtriplexLink );
                                plantModelMaterials[3] = THREE.ImageUtils.loadTexture( texturesAsterLink );
                                plantModelMaterials[4] = THREE.ImageUtils.loadTexture( texturesLimoniumLink );
                                plantModelMaterials[5] = THREE.ImageUtils.loadTexture( texturesArtemisiaLink );
                                plantModelMaterials[6] = THREE.ImageUtils.loadTexture( texturesSalicorniaLink );
                                
                                for(var t = 0; t < plantTypes.length; t++){
                                    plantModelMaterials[t].magFilter = THREE.LinearFilter;
                                    plantModelMaterials[t].minFilter = THREE.LinearFilter;
                                }
                                
                                // Billboards
                                billboards = [];
                                
                                billboardTextureMap.anisotropy = 1;
                                billboardTextureMap.generateMipmaps = true;
                                
                                customMaterialBillboards.uniforms.billboardTextureAtlas.value = billboardTextureMap;
                                customMaterialBillboards.uniforms.threshNear.value = thresholdNear * offsetLOD;
                                customMaterialBillboards.uniforms.threshFar.value = thresholdNear * offsetLOD + transitionZone;
                                customMaterialBillboards.uniforms.threshLODNear.value = thresholdBillboard;
                                customMaterialBillboards.uniforms.threshLODFar.value = thresholdBillboard + transitionZoneBillboards;
                                customMaterialBillboards.sizeAttenuation = true;
                                customMaterialBillboards.uniforms.nTypes.value = 3;
                                customMaterialBillboards.uniforms.overlayFactor.value = overlayFactor;
                                for( var l = 0; l < levelsLOD; l++){
                                    billboards[l] = [];
                                    for(var i = 0; i < objectPositionMerged[l].length; i++){
                                        var _particleGeom = new THREE.BufferGeometry();
                                        _particleGeom.addAttribute( 'position', new THREE.BufferAttribute( billboardPositionsMerged[l][i], 3 ) );
                                        _particleGeom.addAttribute( 'colorInstance', new THREE.BufferAttribute( objectColorRandomMerged[l][i], 3 ) );
                                        _particleGeom.addAttribute( 'plantType', new THREE.BufferAttribute( objectPlantTypeMerged[l][i], 1 ) );
                                        _particleGeom.addAttribute( 'size', new THREE.BufferAttribute( billboardSizesMerged[l][i], 1 ) );
                                        _particleGeom.addAttribute( 'textureNumber', new THREE.BufferAttribute( billboardTextureNumberMerged[l][i], 1 ) );
                                        billboards[l][i] = new THREE.PointCloud( _particleGeom, customMaterialBillboards );
                                        billboards[l][i].frustumCulled = false;
                                        billboards[l][i].autoupdate = false;
                                        billboards[l][i].updateMatrix();
                                        billboards[l][i].visible = false;
                                        sceneBillboard.add(billboards[l][i]);
                                    }
                                }
                                console.log("Billboard creation finished");
                                
                                console.log("Instance object creation");

                                // Load plant MESH
                                instancingMaterials = [];
                                instancingDepthMaterials = [];
                                instancingMaterialReference = new THREE.ShaderMaterial( ShaderLibrary['instancingColorMaterial'] );
                                instancingMaterialReference.vertexColors = THREE.VertexColors;
                                instancingMaterialReference.uniforms.threshNear.value = thresholdNear * offsetLOD;
                                instancingMaterialReference.uniforms.threshFar.value = thresholdNear * offsetLOD + transitionZone;
                                instancingMaterialReference.side = THREE.DoubleSide;
                                
                                var instancingMaterialReference2 = new THREE.ShaderMaterial( ShaderLibrary['instancingTextureMaterial'] );
                                instancingMaterialReference2.uniforms.threshNear.value = thresholdNear * offsetLOD;
                                instancingMaterialReference2.uniforms.threshFar.value = thresholdNear * offsetLOD + transitionZone;
                                instancingMaterialReference2.side = THREE.DoubleSide;
                                for(var t =0; t < plantTypes.length; t++){
                                    instancingMaterials[t] = instancingMaterialReference2.clone();
                                    instancingMaterials[t].uniforms.textureMap.value = plantModelMaterials[t];
                                    instancingMaterials[t].uniforms.nTexture.value = nTextures[t];
                                    
                                    instancingDepthMaterials[t] = depthMaterial.clone();
                                    instancingDepthMaterials[t].uniforms.textureMap.value = plantModelMaterials[t];
                                    instancingDepthMaterials[t].uniforms.nTexture.value = nTextures[t];
                                }
                                
                                plantModelBlocks = [];
                                for(var t = 0; t < plantTypes.length; t++){
                                    plantModelBlocks[t] = [];
                                    for(var j = 0; j < objectPositionMerged[levelsLOD-1].length; j++){
                                        var plantModelInstancedGeom = new THREE.BufferGeometry();
                                        plantModelInstancedGeom.addAttribute( 'position', plantModels[t].geometry.attributes.position);
                                        plantModelInstancedGeom.addAttribute( 'normal', plantModels[t].geometry.attributes.normal);
                                        plantModelInstancedGeom.addAttribute( 'uv', plantModels[t].geometry.attributes.uv);
                                        plantModelInstancedGeom.addAttribute( 'textureIndex', plantModels[t].geometry.attributes.textureIndex );
                                        plantModelInstancedGeom.addAttribute( 'positionInstances', new THREE.BufferAttribute( plantInstancePositions[t][j], 3 ) );
                                        plantModelInstancedGeom.addAttribute( 'colorInstances', new THREE.BufferAttribute( plantInstanceColors[t][j], 3 ) );
                                        plantModelInstancedGeom.addAttribute( 'colorInstance', new THREE.BufferAttribute( plantInstanceColors[t][j], 3 ) );
                                        plantModelInstancedGeom.addAttribute( 'scaleInstances', new THREE.BufferAttribute( plantInstanceScales[t][j], 3 ) );
                                        plantModelInstancedGeom.addAttribute( 'rotateInstances', new THREE.BufferAttribute( plantInstanceRotations[t][j], 3 ) );
                                        plantModelInstancedGeom.attributes.positionInstances.instancing = true;
                                        plantModelInstancedGeom.attributes.colorInstances.instancing = true;
                                        plantModelInstancedGeom.attributes.colorInstance.instancing = true;
                                        plantModelInstancedGeom.attributes.scaleInstances.instancing = true;
                                        plantModelInstancedGeom.attributes.rotateInstances.instancing = true;
                                        
                                        plantModelBlocks[t][j] = new THREE.Mesh( plantModelInstancedGeom, instancingMaterials[t] );
                                        plantModelBlocks[t][j].rotation.x = -Math.PI / 2;
                                        plantModelBlocks[t][j].scale.x *= 1.0;
                                        plantModelBlocks[t][j].scale.y *= 1.0;
                                        plantModelBlocks[t][j].scale.z *= 1.0;
                                        plantModelBlocks[t][j].instancing = true;
                                        plantModelBlocks[t][j].visible = false;
                                        plantModelBlocks[t][j].frustumCulled = false;
                                        plantModelBlocks[t][j].autoupdate = false;
                                        plantModelBlocks[t][j].updateMatrix();
                                        plantModelBlocks[t][j].castShadow = true;
                                        plantModelBlocks[t][j].receiveShadow = true;
                                        plantModelBlocks[t][j].customDepthMaterial = instancingDepthMaterials[t];
                                        sceneObject.add(plantModelBlocks[t][j]);
                                    }
                                }
                                
                                var geo = new THREE.BoxGeometry(.33,.33,.33,1,1,1);
                                geo.computeVertexNormals();
                                var cubeGeo = new THREE.BufferGeometry().fromGeometry(geo);
                                objects = [];
                                for(var i = 0; i < objectPositionMerged[levelsLOD-1].length; i++){
                                    var objectInstancedGeom = new THREE.BufferGeometry();
                                    objectInstancedGeom.addAttribute('position',cubeGeo.attributes.position);
                                    objectInstancedGeom.addAttribute('normal',cubeGeo.attributes.normal);
                                    objectInstancedGeom.addAttribute('uv',cubeGeo.attributes.uv);
                                    objectInstancedGeom.addAttribute( 'positionInstances', new THREE.BufferAttribute( objectPositionMerged[levelsLOD-1][i], 3 ) );
                                    objectInstancedGeom.addAttribute( 'colorInstances', new THREE.BufferAttribute( objectColorsMerged[levelsLOD-1][i], 3 ) );
                                    objectInstancedGeom.addAttribute( 'scaleInstances', new THREE.BufferAttribute( objectScaleMerged[levelsLOD-1][i], 3 ) );
                                    objectInstancedGeom.addAttribute( 'rotateInstances', new THREE.BufferAttribute( objectRotationMerged[levelsLOD-1][i], 3 ) );
                                    objectInstancedGeom.attributes.positionInstances.instancing = true;
                                    objectInstancedGeom.attributes.colorInstances.instancing = true;
                                    objectInstancedGeom.attributes.scaleInstances.instancing = true;
                                    objectInstancedGeom.attributes.rotateInstances.instancing = true;
            
                                    objects[i] = new THREE.Mesh( objectInstancedGeom, instancingMaterialReference );
                                    objects[i].scale.x *= 2.0;
                                    objects[i].scale.y *= 2.0;
                                    objects[i].scale.z *= 2.0;
                                    objects[i].instancing = true;
                                    objects[i].visible = false;
                                    objects[i].frustumCulled = false;
                                    objects[i].autoupdate = false;
                                    objects[i].updateMatrix();
                                    objects[i].castShadow = true;
                                    objects[i].receiveShadow = true;
                                    sceneObject.add(objects[i]);
                                }
                                                                
                                console.log("Finished instance object generation");
                                
                                var fxaaPass = new THREE.ShaderPass(THREE.FXAAShader);
                                fxaaPass.uniforms.resolution.value = new THREE.Vector2(1/pixelWidth,1/pixelHeight);
                                fxaaPass.renderToScreen = true;
                                //Billboards processing
                                var composerBillboards = new THREE.EffectComposer( renderer, renderTargetBillboards );
                                
                                var renderPassBillboards = new THREE.RenderPass( sceneBillboard, camera );
                                var copyPassBillboards = new THREE.ShaderPass(THREE.CopyShader);

                                renderPassBillboards.renderToScreen = false;
                                
				composerBillboards.addPass( renderPassBillboards );
                                composerBillboards.addPass( copyPassBillboards );

                                // Object processing
                                var composerObjects = new THREE.EffectComposer( renderer, renderTargetObjects );
                                var renderPassObjects = new THREE.RenderPass( sceneObject, camera );
                                var copyPassObjects = new THREE.ShaderPass(THREE.CopyShader);
                                
                                renderPassObjects.renderToScreen = false;
                                
                                composerObjects.addPass( renderPassObjects );
                                composerObjects.addPass( copyPassObjects );
                                
                                // Blending processing
                                var composerBlending = new THREE.EffectComposer( renderer, renderTargetBlend );
                                var blendPassObjects = new THREE.ShaderPass(THREE.BlendAdvancedShader);
                                var copyPassBlend = new THREE.ShaderPass(THREE.CopyShader);
                                fxaaPass.uniforms.tDiffuse.value = renderTargetObjects;
                                copyPassBlend.renderToScreen = true;
                                blendPassObjects.uniforms.tDiffuse1.value = composerObjects.renderTarget1;
                                blendPassObjects.uniforms.tDiffuse2.value = composerBillboards.renderTarget1;
                                
                                composerBlending.addPass( blendPassObjects );
                                composerBlending.addPass( copyPassBlend );

				postprocessing.composerBillboards = composerBillboards;
                                postprocessing.composerObjects = composerObjects;
                                postprocessing.composerBlending = composerBlending;
                                // STATS
                                glS = new glStats();
                                tS = new threeStats( renderer );

                                rS = new rStats( {
                                    values: {
                                        frame: { caption: 'Total frame time (ms)', average: true },
                                        fps: { caption: 'Framerate (FPS)', average: true },
                                        calls: { caption: 'Calls (three.js)' },
                                        raf: { caption: 'Time since last rAF (ms)',average:true },
                                        rstats: { caption: 'rStats update (ms)' }
                                    },
                                    groups: [
                                        { caption: 'Framerate', values: [ 'fps', 'raf' ],average:true },
                                        { caption: 'Frame Budget', values: [ 'frame', 'update', 'render' ],average:true }
                                    ],
                                    fractions: [
                                        { base: 'frame', steps: [ 'update', 'render' ],average:true }
                                    ],
                                    plugins: [
                                        tS,
                                        glS
                                    ]
                                } );

				//
				document.addEventListener( 'keydown', onKeyDown, false );
				window.addEventListener( 'resize', onWindowResize, false );

			}
                        
                        function onKeyDown ( event ) {

				switch( event.keyCode ) {

                                        case 80: /*P*/  billboardsVisibility(); break;
                                        case 79: /*O*/  objectsVisibility(); break;
                                        case 66: /*B*/  terrainsVisibility(); break;
                                        case 88: /*X*/  lookat = !lookat; break;
                                        case 72: /*H*/  decreaseFarLOD(); break;
                                        case 76: /*L*/  increaseFarLOD(); break;
                                        case 89: /*Y*/  controls.rollSpeed += 0.0005; break;
                                        case 90: /*Z*/  overlayStatus = !overlayStatus; break;
                                        case 78: /*N*/  controls.rollSpeed -= 0.0005; break;
                                        case 71: /*G*/  controls.movementSpeed -= 0.025 * scale; break; 
                                        case 84: /*T*/  controls.movementSpeed += 0.025 * scale; break;
                                        case 73: /*I*/  increaseLOD(); break;
                                        case 74: /*J*/  decreaseLOD(); break;                                        
                                        case 75: /*K*/  waterVisible = !waterVisible; waterObject.visible = waterVisible; waterBillboard.visible = waterVisible; break;
                                        case 77: /*M*/  toggleShadow(); break; 
                                        case 85: /*U*/  controls.autoForward = !controls.autoForward; break;
                                        case 86: /*V*/  BLENDING_MODE = !BLENDING_MODE; break;
                                        case 67: /*C*/  plantVisible = !plantVisible; if(plantVisible) plantVisibility(); objectsVisible = false; break;

				}

			};

			function onWindowResize() {

				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();
                                
				renderer.setSize( window.innerWidth / resolution, window.innerHeight / resolution);
                                //renderer.setViewport( 0, 0, (window.innerWidth / resolution)*window.devicePixelRatio, (window.innerHeight / resolution)*window.devicePixelRatio );
                                
//                                renderTargetObjects.setSize(window.innerWidth / resolution, window.innerHeight / resolution);
//                                renderTargetBillboards.setSize(window.innerWidth / resolution, window.innerHeight / resolution);
//                                renderTargetBlend.setSize(window.innerWidth / resolution, window.innerHeight / resolution);
				//controls.handleResize();

			}
                        
                        function toggleShadow(){
                            for(var t = 0; t < plantTypes.length; t++){
                                    for(var j = 0; j < plantModelBlocks[t].length; j++){
                                        plantModelBlocks[t][j].castShadow = !plantModelBlocks[t][j].castShadow;
                                    }
                            }
                        }
                        
                        function increaseLOD(){
                            offsetLOD += .25;
                            customMaterialBillboards.uniforms.threshNear.value = thresholdNear * offsetLOD;
                            customMaterialBillboards.uniforms.threshFar.value = thresholdNear * offsetLOD + transitionZone;
                            instancingMaterialReference.uniforms.threshNear.value = thresholdNear * offsetLOD;
                            instancingMaterialReference.uniforms.threshFar.value = thresholdNear * offsetLOD + transitionZone;
                            
                            for(var t = 0; t <  plantTypes.length; t++){
                                instancingMaterials[t].uniforms.threshNear.value = thresholdNear * offsetLOD;
                                instancingMaterials[t].uniforms.threshFar.value = thresholdNear * offsetLOD + transitionZone;
                            }
                            
                            customMaterialPhong.uniforms.threshNear.value = thresholdNear * offsetLOD;
                            customMaterialPhong.uniforms.threshFar.value = thresholdNear * offsetLOD + transitionZone;
                            customMaterialLambert.uniforms.threshNear.value = thresholdNear * offsetLOD;
                            customMaterialLambert.uniforms.threshFar.value = thresholdNear * offsetLOD + transitionZone;
                            
                            waterObject.waterMesh.material.uniforms.threshNear.value = thresholdNear * offsetLOD;
                            waterObject.waterMesh.material.uniforms.threshFar.value = thresholdNear * offsetLOD + transitionZone;

                            waterBillboard.waterMesh.material.uniforms.threshNear.value = thresholdNear * offsetLOD;
                            waterBillboard.waterMesh.material.uniforms.threshFar.value = thresholdNear * offsetLOD + transitionZone;
                        }
                        
                        function decreaseLOD(){
                            if (offsetLOD > 0){
                                offsetLOD -= .25;
                                customMaterialBillboards.uniforms.threshNear.value = thresholdNear * offsetLOD;
                                customMaterialBillboards.uniforms.threshFar.value = thresholdNear * offsetLOD + transitionZone;
                                instancingMaterialReference.uniforms.threshNear.value = thresholdNear * offsetLOD;
                                instancingMaterialReference.uniforms.threshFar.value = thresholdNear * offsetLOD + transitionZone;
                                
                                for(var t = 0; t <  plantTypes.length; t++){
                                    instancingMaterials[t].uniforms.threshNear.value = thresholdNear * offsetLOD;
                                    instancingMaterials[t].uniforms.threshFar.value = thresholdNear * offsetLOD + transitionZone;
                                }
                                
                                customMaterialPhong.uniforms.threshNear.value = thresholdNear * offsetLOD;
                                customMaterialPhong.uniforms.threshFar.value = thresholdNear * offsetLOD + transitionZone;
                                customMaterialLambert.uniforms.threshNear.value = thresholdNear * offsetLOD;
                                customMaterialLambert.uniforms.threshFar.value = thresholdNear * offsetLOD + transitionZone;
                                waterObject.waterMesh.material.uniforms.threshNear.value = thresholdNear * offsetLOD;
                                waterObject.waterMesh.material.uniforms.threshFar.value = thresholdNear * offsetLOD + transitionZone;
                                
                                waterBillboard.waterMesh.material.uniforms.threshNear.value = thresholdNear * offsetLOD;
                                waterBillboard.waterMesh.material.uniforms.threshFar.value = thresholdNear * offsetLOD + transitionZone;
                            }
                        }
                        
                        function increaseFarLOD(){
                            thresholdBillboard += 2 * scale;
                            customMaterialLambert.uniforms.threshLODNear.value = thresholdBillboard - transitionZoneBillboards * offsetLODTerrain;
                            customMaterialLambert.uniforms.threshLODFar.value = thresholdBillboard + transitionZoneBillboards * offsetLODTerrain;
                            
                            customMaterialBillboards.uniforms.threshLODNear.value = thresholdBillboard;
                            customMaterialBillboards.uniforms.threshLODFar.value = thresholdBillboard + transitionZoneBillboards;
                        }
                        
                        function decreaseFarLOD(){
                            thresholdBillboard -= 2 * scale;
                            customMaterialLambert.uniforms.threshLODNear.value = thresholdBillboard - transitionZoneBillboards * offsetLODTerrain;
                            customMaterialLambert.uniforms.threshLODFar.value = thresholdBillboard + transitionZoneBillboards * offsetLODTerrain;
                            
                            customMaterialBillboards.uniforms.threshLODNear.value = thresholdBillboard;
                            customMaterialBillboards.uniforms.threshLODFar.value = thresholdBillboard + transitionZoneBillboards;
                        }
                        
                        function distance(x1,y1,x2,y2){
                            return Math.sqrt((x2-x1) * (x2-x1) + (y2-y1) * (y2-y1));
                        }
                        
                        function generateTerrainQuad(width,depth,startWidth,startDepth,parentTerrainQuad, customMaterialPhong){
                            var positions = parentTerrainQuad.geometry.attributes.position.array;
                            var indices = parentTerrainQuad.geometry.attributes.index.array;
                            var normals = parentTerrainQuad.geometry.attributes.normal.array;
                            var uvs = parentTerrainQuad.geometry.attributes.uv.array;
                            var nPlants = parentTerrainQuad.geometry.attributes.nPlants.array;
                            var tColors = parentTerrainQuad.geometry.attributes.tColor.array;
                            var tTypes = parentTerrainQuad.geometry.attributes.tType.array;
                            
                            var parentWidth = Math.ceil(parentTerrainQuad.geometry.boundingBox.size().x / scale);
                            
                            var positions2 = new Float32Array( width * depth * 3 );
                            var indices2 = new Uint32Array( (width-1) * (depth-1) * 6 );   
                            var normals2 = new Float32Array( width * depth * 3 );
                            var uvs2 = new Float32Array( width * depth * 2 );
                            var nPlants2 = new Float32Array( width * depth);
                            var tColors2 = new Float32Array( width * depth * 3);
                            var tTypes2 = new Float32Array( width * depth );

                            var index = 0;
                            var index2 = 0;
                            // should be updated when different planeblocks are created
                            var startIndex = startWidth + startDepth * (parentWidth-1);
                            var startInd = indices[startIndex*6];
                            for(var bd  = 0; bd < depth-1; bd++){
                                index = startIndex*6 + bd * (parentWidth-1) * 6;
                                for(var bw = 0; bw < width-1; bw++){
                                    var i0 = indices[index+0];
                                    var i1 = indices[index+1];
                                    var i2 = indices[index+2];
                                    var i3 = indices[index+3];
                                    var i4 = indices[index+4];
                                    var i5 = indices[index+5];
                                    var h0 = positions[i0*3+1];
                                    var h1 = positions[i1*3+1];
                                    var h2 = positions[i2*3+1];
                                    var h3 = positions[i3*3+1];
                                    var h4 = positions[i4*3+1];
                                    var h5 = positions[i5*3+1];
                                    i0 -= bd * (parentWidth - width);
                                    i1 -= bd * (parentWidth - width);
                                    i2 -= bd * (parentWidth - width);
                                    i3 -= bd * (parentWidth - width);
                                    i4 -= bd * (parentWidth - width);
                                    i5 -= bd * (parentWidth - width);
                                    var avgi = (i0 + i2 + i2 + i3 + i4 + i5) / 6;
                                    var i0n = i0 - startInd - (i0 > avgi) * (parentWidth - width);
                                    var i1n = i1 - startInd - (i1 > avgi) * (parentWidth - width);
                                    var i2n = i2 - startInd - (i2 > avgi) * (parentWidth - width);
                                    var i3n = i3 - startInd - (i3 > avgi) * (parentWidth - width);
                                    var i4n = i4 - startInd - (i4 > avgi) * (parentWidth - width);
                                    var i5n = i5 - startInd - (i5 > avgi) * (parentWidth - width);

                                    //if(h0 > scale*.025 && h1 > scale*.025 && h2 > scale*.025){
                                    indices2[index2+0] = i0n;
                                    indices2[index2+1] = i1n;
                                    indices2[index2+2] = i2n;
                                    index2 += 3;
                                    //}
                                    //if(h3 > scale*.025 && h4 > scale*.025 && h5 > scale*.025){
                                    indices2[index2+0] = i3n;
                                    indices2[index2+1] = i4n;
                                    indices2[index2+2] = i5n;
                                    index2 += 3;
                                    //}
                                    index += 6;                                            
                                }
                            }

                            var index1 = 0;
                            var index2 = 0;
                            var index3 = 0;
                            var index4 = 0;
                            var index5 = 0;
                            var index6 = 0;
                            var startIndex = startWidth + startDepth * (parentWidth-0);
                            for(var bd  = 0; bd < depth; bd++){
                                index1 = startIndex * 3 + bd * (parentWidth-0) * 3;
                                index3 = startIndex * 2 + bd * (parentWidth-0) * 2;
                                index5 = startIndex * 1 + bd * (parentWidth-0) * 1;
                                for(var bw = 0; bw < width; bw++){
                                    positions2[index2+0] = positions[index1+0];
                                    positions2[index2+1] = positions[index1+1];
                                    positions2[index2+2] = positions[index1+2];
                                    normals2[index2+0] = normals[index1+0];
                                    normals2[index2+1] = normals[index1+1];
                                    normals2[index2+2] = normals[index1+2];
                                    uvs2[index4+0] = uvs[index3+0];
                                    uvs2[index4+1] = uvs[index3+1];
                                    nPlants2[index6] = nPlants[index5];
                                    tColors2[index2+0] = tColors[index1+0];
                                    tColors2[index2+1] = tColors[index1+1];
                                    tColors2[index2+2] = tColors[index1+2];
                                    tTypes2[index6] = tTypes[index5];

                                    index1 += 3;
                                    index2 += 3;
                                    index3 += 2;
                                    index4 += 2;
                                    index5 += 1;
                                    index6 += 1;
                                }
                            }

                            var geometryBlock = new THREE.BufferGeometry();

                            geometryBlock.addAttribute( 'index', new THREE.BufferAttribute( indices2, 1 ) );
                            geometryBlock.addAttribute( 'position', new THREE.BufferAttribute( positions2, 3 ) );
                            geometryBlock.addAttribute( 'normal', new THREE.BufferAttribute( normals2, 3 ) );
                            geometryBlock.addAttribute( 'uv', new THREE.BufferAttribute( uvs2, 2 ) );
                            geometryBlock.addAttribute( 'nPlants', new THREE.BufferAttribute( nPlants2, 1 ) );
                            geometryBlock.addAttribute( 'tColor', new THREE.BufferAttribute( tColors2, 3 ) );
                            geometryBlock.addAttribute( 'tType', new THREE.BufferAttribute( tTypes2, 1 ) );

                            geometryBlock.computeBoundingSphere();
                            geometryBlock.computeBoundingBox();
                            var terrainQuad = new THREE.Mesh(geometryBlock, customMaterialPhong);
                            terrainQuad.frustumCulled = false;
                            terrainQuad.autoupdate = false;
                            terrainQuad.visible = false;
                            terrainQuad.updateMatrix();
                            return terrainQuad;
                        }
                        
                        function drawLines(mesh){
                            //Draw Level of Detail lines
                            var meshPositions = mesh.geometry.attributes.position.array;
                            var size = mesh.geometry.boundingBox.size();
                            var width = Math.ceil(size.x / scale)+0;
                            var depth = Math.ceil(size.z / scale)+0;
                            
                            var geometryLines = new THREE.BufferGeometry();
                            var positionsLines = new Float32Array((depth-1.5)*2*3 + (width)*2*3);
                            var indexLine = 0;
                            
                            for(var i = 0; i < width*3; i+=3){
                                positionsLines[indexLine+0] = meshPositions[i + 0];
                                positionsLines[indexLine+1] = meshPositions[i + 1] + scale * 0.05;
                                positionsLines[indexLine+2] = meshPositions[i + 2];
                                indexLine += 3;
                            }
                            
                            var startIndex = (width-1)*3;
                            for(var i = 3; i < (depth-1)*3; i+=3){
                                positionsLines[indexLine+0] = meshPositions[startIndex+i*width + 0];
                                positionsLines[indexLine+1] = meshPositions[startIndex+i*width + 1] + scale * 0.05;
                                positionsLines[indexLine+2] = meshPositions[startIndex+i*width + 2];
                                indexLine += 3;
                            }
                            
                            startIndex = width*(depth-1)*3;
                            for(var i = (width-1)*3; i >= 0; i-=3){
                                positionsLines[indexLine+0] = meshPositions[startIndex+i + 0];
                                positionsLines[indexLine+1] = meshPositions[startIndex+i + 1] + scale * 0.05;
                                positionsLines[indexLine+2] = meshPositions[startIndex+i + 2];
                                indexLine += 3;
                            }
                            
                            var startIndex = 0;
                            for(var i = (depth-2)*3; i >= 0; i-=3){
                                positionsLines[indexLine+0] = meshPositions[startIndex+i*width + 0];
                                positionsLines[indexLine+1] = meshPositions[startIndex+i*width + 1] + scale * 0.05;
                                positionsLines[indexLine+2] = meshPositions[startIndex+i*width + 2];
                                indexLine += 3;
                            }
                            
                            
                            geometryLines.addAttribute( 'position', new THREE.BufferAttribute( positionsLines, 3 ) );
                            geometryLines.computeBoundingSphere();
                            
                            var lineLOD = new THREE.Line(geometryLines, materialLines);
                            
                            lineLOD.frustumCulled = false;
                            lineLOD.autoupdate = false;
                            lineLOD.visible = false;
                            lineLOD.updateMatrix();
                            
                            return lineLOD;
                        }
                        
                        function getHeight(img) {
                                var canvas = document.createElement('canvas');
                                canvas.width = img.width;
                                canvas.height = img.height;
                                var context = canvas.getContext('2d');
                                context.drawImage(img,0,0,img.width, img.height);
                                var pix = context.getImageData(0,0, img.width, img.height).data;                                
                            var size = img.width * img.height;
                            var data = new Float32Array( size );

                                var j=0;
                                for (var i = 0; i<pix.length; i +=4) {
                                    data[j++] = pix[i] / 255;
                                }

                                return data;
                        }
                        
                        function preloadimages(arr){
                            var newimages=[], loadedimages=0;
                            var postaction=function(){};
                            //var arr=(typeof arr!=="object")? [arr] : arr;
                            function imageloadpost(){
                                loadedimages++;
                                if (loadedimages===arr.length){
                                    postaction(newimages); //call postaction and pass in newimages array as parameter
                                }
                            }
                            for (var i=0; i<arr.length; i++){
                                newimages[i]=new Image();
                                newimages[i].crossOrigin = '';
                                newimages[i].onload=function(){
                                    imageloadpost();
                                };
                                newimages[i].onerror=function(){
                                    imageloadpost();
                                };
                                newimages[i].src=arr[i];
                            }
                            return { //return blank object with done() method
                                done:function(f){
                                    postaction=f || postaction; //remember user defined callback functions to be called when images load
                                }
                            };
                        }
                        
                        function preLoadPlantModel(arr){
                            var loadedModels=[];
                            var loaded = 0;
                            var postaction=function(){};
                            function plantModelsloadpost(object, index){
                                loadedModels[index] = object;
                                loaded++;
                                if((arr.length / 2) === loaded){
                                    postaction(loadedModels); //call postaction and pass in newimages array as parameter\
                                }
                            }
                            for(var i = 0; i < arr.length; i+=2){
                                var loader = new THREE.OBJMTLLoader();
                                loader.load( arr[i], arr[i+1], function ( object ) {
                                    var texIndex = 1.0;
                                    var plantModelGeometry = new THREE.BufferGeometry();
                                    plantModelGeometry.addAttribute('position',new THREE.BufferAttribute(new Float32Array(0),3));
                                    plantModelGeometry.addAttribute('normal',new THREE.BufferAttribute(new Float32Array(0),3));
                                    plantModelGeometry.addAttribute('uv',new THREE.BufferAttribute(new Float32Array(0),2));
                                    plantModelGeometry.addAttribute('textureIndex',new THREE.BufferAttribute(new Float32Array(0),1));
                                    object.traverse( function ( child ) {
                                        if(child.material instanceof THREE.MeshPhongMaterial){
                                            //console.log(child.material.name);
                                            child.geometry.computeVertexNormals();
                                            child.geometry = new THREE.BufferGeometry().fromGeometry(child.geometry);

                                            var texIndices = new Float32Array(child.geometry.attributes.position.length / 3);
                                            for(var t = 0; t < texIndices.length; t++){
                                                texIndices[t] = texIndex;
                                            }
                                            child.geometry.addAttribute('textureIndex',new THREE.BufferAttribute(texIndices,1));
                                            plantModelGeometry.merge(child.geometry);

                                            texIndex++; 
                                        }
                                    });
                                    
                                    var plantModel = new THREE.Mesh(plantModelGeometry);
                                    plantModel.rotation.x = -Math.PI / 2;
                                    plantModel.autoupdate = false;
                                    plantModel.updateMatrix();
                                    plantModel.frustumCulled = false;
                                    plantModel.visible = false;
                                    
                                    var plantIndex = 0;
                                    console.log(object.children[2].material.name);
                                    for(var t = 0; t < plantTypes.length; t++){
                                        if(object.children[2].material.name.indexOf(plantTypes[t]) >= 0){
                                            plantIndex = t;
                                            break;
                                        }
                                    }

                                    plantModelsloadpost(plantModel, plantIndex);
                                });
                            }
                            return { //return blank object with done() method
                                done:function(f){
                                    postaction=f || postaction; //remember user defined callback functions to be called when images load
                                }
                            };
                        }
                        
                        function preLoadDike(dikeLink){
                            var loadedDike;
                            var postaction=function(){};
                            function dikeloadpost(){
                                postaction(loadedDike); //call postaction and pass in newimages array as parameter\
                            }
                            
                            var loader = new THREE.OBJLoader();
                            loader.load( dikeLink, function ( object ) {
                                
                                var material = new THREE.ShaderMaterial(ShaderLibrary["dykeShader"]);
                                loadedDike = new THREE.Mesh(object.children[0].geometry, material);
                                dikeloadpost();
                            });
                            return { //return blank object with done() method
                                done:function(f){
                                    postaction=f || postaction; //remember user defined callback functions to be called when images load
                                }
                            };
                        }
                        
                        function preLoadLocations(textLink){
                            var loadedLocations = [];
                            var postaction=function(){};
                            function locationsloadpost(){
                                postaction(loadedLocations); //call postaction and pass in newimages array as parameter
                            }
                            
                            var rawFile = new XMLHttpRequest();
                            rawFile.open("GET", textLink);
                            rawFile.onreadystatechange = function ()
                            {
                                if(rawFile.readyState === 4 && rawFile.status === 200)
                                {
                                    var allText = rawFile.responseText;
                                    var textLocations = allText.split(/[\s\n]+/);

                                    for (var i = 0; i < textLocations.length-1; i+=3){
                                        loadedLocations[i + 0] = parseFloat(textLocations[i + 1]);
                                        loadedLocations[i + 1] = parseFloat(textLocations[i + 0]);
                                        loadedLocations[i + 2] = parseFloat(textLocations[i + 2]);
                                    }

                                    locationsloadpost();
                                }
                            };
                            rawFile.send();
                            
                            return { //return blank object with done() method
                                done:function(f){
                                    postaction=f || postaction; //remember user defined callback functions to be called when images load
                                }
                            };
                        }
                        
                        function plantVisibility(){
                            if(plantVisible){
                                //customMaterialBillboards.uniforms.scale.value = 500;
                                customMaterialBillboards.uniforms.billboardTextureAtlas.value = billboardTextureMap;
                            }
                        }
                        
                        function billboardsVisibility(){
                            billboardsVisible = !billboardsVisible;
                        }
                        
                        function objectsVisibility(){
                           objectsVisible = !objectsVisible;
                           plantVisible = false;
                           
                           if(objectsVisible){
                                //customMaterialBillboards.uniforms.scale.value = scale * 1.0;
                                customMaterialBillboards.uniforms.billboardTextureAtlas.value = billboardTextures;
                           }
                        }
                        
                        function terrainsVisibility(){
                            terrainsVisible = !terrainsVisible;
                        }
                        
                        function linesLODVisibility(){
                            linesLODVisible = !linesLODVisible;
                        }
                        
			function animate() {
                                rS( 'frame' ).start();
                                glS.start();
                                rS( 'rAF' ).tick();
                                rS( 'FPS' ).frame();
                                
//                                setTimeout( function() {
                                requestAnimationFrame( animate );
//                                }, 1000 / 30 );
                                controls.update( 1 );
                                render();
                                
                                rS( 'frame' ).end();
				rS( 'rStats' ).start();
                                rS().update();
                                rS( 'rStats' ).end();

			}

			function render() {
                                rS( 'update' ).start();

                                if(overlayStatus && overlayFactor < 0.2){
                                    overlayFactor += 0.005;
                                    customMaterialBillboards.uniforms.overlayFactor.value = overlayFactor * 2;
                                    customMaterialLambert.uniforms.overlayFactor.value = overlayFactor;
                                }
                                else if(!overlayStatus && overlayFactor > 0.0){
                                    overlayFactor -= 0.005;
                                    customMaterialBillboards.uniforms.overlayFactor.value = overlayFactor * 2;
                                    customMaterialLambert.uniforms.overlayFactor.value = overlayFactor;
                                }
                                
                                worldCoordinates = new THREE.Vector3();
                                worldCoordinates.setFromMatrixPosition( this.camera.matrixWorld );
                                waterObject.waterMesh.material.uniforms.eye.value = worldCoordinates;
                                waterBillboard.waterMesh.material.uniforms.eye.value = worldCoordinates;

                                frustum.setFromMatrix( new THREE.Matrix4().multiplyMatrices( camera.projectionMatrix, camera.matrixWorldInverse ) );
                                
                                children = [];
                                childrenNew = [];
                                if(lookat){
                                    camera.lookAt(new THREE.Vector3(0,0,0));
                                }
                                camPos.x = camera.position.x;
                                camPos.y = camera.position.z;
                                maxDist = (thresholdNear * offsetLOD + transitionZone) * 2;
                                maxDistBillboard = (thresholdBillboard + transitionZoneBillboards) * 2;
                                objectBox.setFromCenterAndSize(camPos, new THREE.Vector2(maxDist,maxDist));
                                billboardBox.setFromCenterAndSize(camPos, new THREE.Vector2(maxDistBillboard,maxDistBillboard));
                                children[0] = true;
                                
                                lightsObject.update(camera.position);
                                
                                for (var l = 0; l < levelsLOD; l++){
                                    if(l < levelsLOD-1){
                                        childrenNew = [];
                                        for (var i = 0; i < terrains[l].length; i++){
                                            if( children[i] ) {
                                                objectRange = objectBox.isIntersectionBox(terrainBoxes[l][i]);
                                                billboardRange = billboardBox.isIntersectionBox(terrainBoxes[l][i]);
                                                bboxT = terrains[l][i].geometry.boundingBox;
                                                frustT = frustum.containsBox( bboxT, offsetFrustum );
                                                if (frustT === 0 && !objectRange && !billboardRange){
                                                    terrains[l][i].visible = terrainsVisible && true;
                                                    linesLOD[l][i].visible = linesLODVisible && true;
                                                    billboards[l][terrainToObjectIDs[l][i]].visible = billboardsVisible && false;
                                                    childrenNew[i*4 + 0] = false;
                                                    childrenNew[i*4 + 1] = false;
                                                    childrenNew[i*4 + 2] = false;
                                                    childrenNew[i*4 + 3] = false;
                                                }
                                                else if (frustT === 0 && !objectRange && billboardRange){
                                                    terrains[l][i].visible = terrainsVisible && true;
                                                    linesLOD[l][i].visible = linesLODVisible && true;
                                                    billboards[l][terrainToObjectIDs[l][i]].visible = billboardsVisible && true;
                                                    childrenNew[i*4 + 0] = false;
                                                    childrenNew[i*4 + 1] = false;
                                                    childrenNew[i*4 + 2] = false;
                                                    childrenNew[i*4 + 3] = false;
                                                }
                                                else if(frustT === 6){
                                                    terrains[l][i].visible = false;
                                                    linesLOD[l][i].visible = false;
                                                    billboards[l][terrainToObjectIDs[l][i]].visible = false;
                                                    childrenNew[i*4 + 0] = false;
                                                    childrenNew[i*4 + 1] = false;
                                                    childrenNew[i*4 + 2] = false;
                                                    childrenNew[i*4 + 3] = false;
                                                }
                                                else if(frustT > 0 || !distT){
                                                    terrains[l][i].visible = false;
                                                    linesLOD[l][i].visible = false;
                                                    billboards[l][terrainToObjectIDs[l][i]].visible = false;
                                                    childrenNew[i*4 + 0] = true;
                                                    childrenNew[i*4 + 1] = true;
                                                    childrenNew[i*4 + 2] = true;
                                                    childrenNew[i*4 + 3] = true;
                                                }
                                            }
                                            else{
                                                terrains[l][i].visible = false;
                                                linesLOD[l][i].visible = false;
                                                billboards[l][terrainToObjectIDs[l][i]].visible = false;
                                                childrenNew[i*4 + 0] = false;
                                                childrenNew[i*4 + 1] = false;
                                                childrenNew[i*4 + 2] = false;
                                                childrenNew[i*4 + 3] = false;
                                            }
                                        }
                                        children = childrenNew;
                                    }
                                    else{
                                        for (var i = 0; i < terrains[l].length; i++){
                                            if(children[i]){
                                                frustT = frustum.intersectsObject( terrains[l][i] );
                                                objectRange = objectBox.isIntersectionBox(terrainBoxes[l][i]);
                                                dist = terrainBoxes[l][i].distanceToPoint(camPos) < maxDist;

                                                if(frustT && objectRange && dist){
                                                    terrains[l][i].visible = terrainsVisible && true;
                                                    terrainObjects[i].visible = terrainsVisible && true;
                                                    linesLOD[l][i].visible = linesLODVisible && true;
                                                    objects[terrainToObjectIDs[l][i]].visible = objectsVisible && true;
                                                    for(var t = 0; t < plantTypes.length; t++){
                                                        plantModelBlocks[t][terrainToObjectIDs[l][i]].visible = plantVisible && true;
                                                    }
                                                    billboards[l][terrainToObjectIDs[l][i]].visible = billboardsVisible && true;
                                                }
                                                else if(frustT){
                                                    terrains[l][i].visible = terrainsVisible && true;
                                                    linesLOD[l][i].visible = linesLODVisible && true;
                                                    terrainObjects[i].visible = false;
                                                    objects[terrainToObjectIDs[l][i]].visible = false;
                                                    for(var t = 0; t < plantTypes.length; t++){
                                                        plantModelBlocks[t][terrainToObjectIDs[l][i]].visible = false;
                                                    }
                                                    billboards[l][terrainToObjectIDs[l][i]].visible = billboardsVisible && true;
                                                }
                                                else{
                                                    terrains[l][i].visible = false;
                                                    linesLOD[l][i].visible = false;
                                                    terrainObjects[i].visible = false;
                                                    objects[terrainToObjectIDs[l][i]].visible = false;
                                                    for(var t = 0; t < plantTypes.length; t++){
                                                        plantModelBlocks[t][terrainToObjectIDs[l][i]].visible = false;
                                                    }
                                                    billboards[l][terrainToObjectIDs[l][i]].visible = false;
                                                }
                                            }
                                            else{
                                                terrains[l][i].visible = false;
                                                linesLOD[l][i].visible = false;
                                                terrainObjects[i].visible = false;
                                                objects[terrainToObjectIDs[l][i]].visible = false;
                                                for(var t = 0; t < plantTypes.length; t++){
                                                    plantModelBlocks[t][terrainToObjectIDs[l][i]].visible = false;
                                                }
                                                billboards[l][terrainToObjectIDs[l][i]].visible = false;
                                            }
                                        }
                                    }
                                }
                                rS( 'update' ).end();
                                rS( 'render' ).start();
                                renderer.clear();
                                if (BLENDING_MODE){
                                    postprocessing.composerBillboards.render( 0.1 );
                                    postprocessing.composerObjects.render( 0.1 );
                                    postprocessing.composerBlending.render ( 0.1 );
                                }
                                else{
                                    renderer.render( sceneBillboard, camera);
				    renderer.render( sceneObject, camera );
                                }
                                                                
                                rS( 'render' ).end();                                
			}

		</script>

	</body>
</html>
